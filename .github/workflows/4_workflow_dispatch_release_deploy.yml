name: 4 Flow - Deploy release to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version (e.g. 10)"
        required: true

jobs:
  deploy-to-production:
    runs-on: ubuntu-latest

    steps:
      - name: Save SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem
          
      - name: Check Docker image exists
        run: |
          echo "${{ secrets.YC_OAUTH_TOKEN }}" | docker login --username oauth --password-stdin cr.yandex
          docker manifest inspect cr.yandex/${{ secrets.YC_ID_CONTAINER }}/app:${{ github.event.inputs.release_version }}_latest > /dev/null

      - name: Deploy to VM via SSH
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            echo "${{ secrets.YC_OAUTH_TOKEN }}" | docker login --username oauth --password-stdin cr.yandex
            docker pull cr.yandex/${{ secrets.YC_ID_CONTAINER }}/app:${{ github.event.inputs.release_version }}_latest
            docker stop app || true
            docker rm app || true
            docker run -d --name app -p 80:3000 cr.yandex/${{ secrets.YC_ID_CONTAINER }}/app:${{ github.event.inputs.release_version }}_latest
          EOF

      - name: Add comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +"%Y-%m-%d %H:%M:%S")
          VERSION=${{ github.event.inputs.release_version }}
          AUTHOR=${{ github.actor }}
          LINK="cr.yandex/${{ secrets.YC_ID_CONTAINER }}/app:${VERSION}_latest"
          WEB="http://${{ secrets.SSH_HOST }}/hw/store/"

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³
          CUR_TAG=$(git describe --tags --abbrev=0)

          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³ Ð¿Ð¾ Ð¿Ð¾Ñ€ÑÐ´ÐºÑƒ (Ñ‡Ð¸ÑÑ‚Ñ‹Ðµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹ Ð¸ Ñ„Ð¸ÐºÑ-Ñ€ÐµÐ»Ð¸Ð·Ñ‹)
          PREV_TAG=$(git tag --sort=-creatordate | grep -E '^[0-9]+(_fix[0-9]+)?$' | grep -B1 "^$CUR_TAG$" | head -n 1)

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ changelog Ð¼ÐµÐ¶Ð´Ñƒ PREV_TAG Ð¸ CUR_TAG
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CUR_TAG" ]; then
            CHANGELOG="- ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· â€” Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          else
            CHANGELOG=$(git log "$PREV_TAG".."$CUR_TAG" --pretty=format:"- %s (%an)")
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="- ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¼ÐµÐ¶Ð´Ñƒ $PREV_TAG Ð¸ $CUR_TAG"
            fi
          fi

          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐ»Ð¾ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ
          BODY=$(cat <<EOF
          âœ… Ð ÐµÐ»Ð¸Ð· Ð²Ñ‹ÐºÐ°Ñ‡Ð°Ð½ Ð² Ð¿Ñ€Ð¾Ð´

          - ðŸ“… Ð”Ð°Ñ‚Ð°: $DATE
          - ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $AUTHOR
          - ðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ: $VERSION
          - ðŸ³ Docker Ð¾Ð±Ñ€Ð°Ð·: \`$LINK\`
          - ðŸŒ Web: [$WEB]($WEB)

          ## Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:
          $CHANGELOG
          EOF
          )

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€ issue Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
          ISSUE_NUMBER=$(gh issue list --state open --search "Release $VERSION" --json number -q ".[0].number")
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Issue for Release $VERSION not found."
            exit 1
          fi

          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð² issue
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"




