name: 2 Flow - Manual release

on:
  workflow_dispatch:

jobs:
# –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ª–∏–Ω—Ç–µ—Ä –∏ —Ç–µ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test
# –∑–¥–µ—Å—å –∏ –¥–∞–ª—å—à–µ –≤–µ—Ä—Å–∏–µ–π —Ä–µ–ª–∏–∑–∞ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –Ω–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ —Ñ–ª–æ—É ${{ github.run_number }}
# –æ—Ç–≤–æ–¥–∏—Ç –æ—Ç main —Ä–µ–ª–∏–∑—É–Ω—é –≤–µ—Ç–∫—É releases/<–≤–µ—Ä—Å–∏—è_—Ä–µ–ª–∏–∑–∞>
  create-release-branch:
    needs: checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –Ω—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ç–∫–∏

      - name: Set release version
        id: release
        run: echo "version=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b releases/${{ steps.release.outputs.version }}
          git push origin releases/${{ steps.release.outputs.version }}
# —Å–æ–±–∏—Ä–∞–µ—Ç docker-–æ–±—Ä–∞–∑ —Å –¥–≤—É–º—è —Ç–µ–≥–∞–º–∏ —Ç–µ–≥–∞–º–∏:
# - cr.yandex/<–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä_—Ä–µ–µ—Å—Ç—Ä–∞>/app:<–≤–µ—Ä—Å–∏—è_—Ä–µ–ª–∏–∑–∞>
# - cr.yandex/<–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä_—Ä–µ–µ—Å—Ç—Ä–∞>/app:<–≤–µ—Ä—Å–∏—è_—Ä–µ–ª–∏–∑–∞>_latest
# –∑–∞–≥—Ä—É–∂–∞–µ—Ç docker-–æ–±—Ä–∞–∑ –≤ Container Registry (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã —Ä–µ–¥–∂–∏—Å—Ç—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –æ–±–∞ —Ç–µ–≥–∞)
  build-and-push-docker:
    needs: create-release-branch
    runs-on: ubuntu-latest
    env:
      REGISTRY: cr.yandex/"${{ secrets.YC_ID_CONTAINER }}"
      IMAGE_NAME: app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set release version
        id: release
        run: echo "version=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Login to Yandex Container Registry
        run: echo "${{ secrets.YC_OAUTH_TOKEN }}" | docker login  --username oauth --password-stdin cr.yandex

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${{ steps.release.outputs.version }} .
          docker tag $REGISTRY/$IMAGE_NAME:${{ steps.release.outputs.version }} $REGISTRY/$IMAGE_NAME:${{ steps.release.outputs.version }}_latest

      - name: Push Docker image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.release.outputs.version }}
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.release.outputs.version }}_latest

# —Å–æ–∑–¥–∞—ë—Ç —Ç–µ–≥, —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –≤ –≥–ª–∞–≤–Ω–æ–π –≤–µ—Ç–∫–µ
  create-tag:
    needs: create-release-branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤—Å–µ –∫–æ–º–º–∏—Ç—ã –∏ –¥–µ–ª–∞—Ç—å git tag

      - name: Set release version
        id: version
        run: echo "VERSION=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Create and push Git tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # –£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–º—Å—è, —á—Ç–æ –Ω–∞ main
          git checkout main

          # –°–æ–∑–¥–∞—ë–º —Ç–µ–≥ –∏ –ø—É—à–∏–º
          git tag $VERSION
          git push origin $VERSION

# —Å–æ–∑–¥–∞—ë—Ç Issue –≤ GitHub, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
# - –¥–∞—Ç—É,
# - –∞–≤—Ç–æ—Ä–∞ —Ä–µ–ª–∏–∑–∞ (—Ç–æ—Ç, –∫—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª —Ñ–ª–æ—É),
# - –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏ (${{ github.run_number }}),
# - —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ (–∏–ª–∏ —Ñ–∏–∫—Å—Ä–µ–ª–∏–∑–Ω–æ–≥–æ) —Ç–µ–≥–∞,
# - —Å—Å—ã–ª–∫—É –Ω–∞ docker-–æ–±—Ä–∞–∑–æ–º –≤ Yandex Container Registry cr.yandex/<–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä_—Ä–µ–µ—Å—Ç—Ä–∞>/app:<–≤–µ—Ä—Å–∏—è_—Ä–µ–ª–∏–∑–∞>

# –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∞–π–ª CHANGELOG.md –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –¥–æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–µ—Ä—Ö—É –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ –≤–∏–¥–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞, –∞ –ø–æ–¥ –Ω–µ–π ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ (–∏–ª–∏ —Ñ–∏–∫—Å—Ä–µ–ª–∏–∑–Ω–æ–≥–æ) —Ç–µ–≥–∞

  create-issue-and-changelog:
    needs: create-tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Get previous tag
        id: previous-tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep -E '^[0-9]+$' | sed -n '2p')
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Get commits between tags
        id: changelog
        run: |
          LOG=$(git log --pretty=format:"- %s (%an)" ${{ steps.previous-tag.outputs.prev_tag }}..HEAD)
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: peter-evans/create-issue@v5
        with:
          title: Release ${{ github.run_number }}
          body: |
            üì¶ **Release ${{ github.run_number }}**
            üìÖ Date: ${{ github.event_date || github.event.head_commit.timestamp }}
            üë§ Author: ${{ github.actor }}
            üîñ Version: ${{ github.run_number }}

            ### Changelog:
            ${{ steps.changelog.outputs.log }}

            ### Docker image:
            cr.yandex/"${{ secrets.YC_ID_CONTAINER }}"/app:${{ github.run_number }}

      - name: Update CHANGELOG.md
        run: |
          echo -e "## Version ${{ github.run_number }}\n${{ steps.changelog.outputs.log }}\n\n$(cat CHANGELOG.md)" > CHANGELOG.md

      - name: Commit updated CHANGELOG.md
        run: |
          git add CHANGELOG.md
          git commit -m "docs: update changelog for release ${{ github.run_number }}"
          git push origin HEAD:main
